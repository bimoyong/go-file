package handler

import (
	"context"
	"encoding/base64"
	"fmt"
	"io"
	"strings"
	"testing"
	"time"

	"github.com/micro/go-micro/v2"
	"github.com/micro/go-micro/v2/client"
	"github.com/micro/go-micro/v2/config"
	log "github.com/micro/go-micro/v2/logger"
	"github.com/micro/go-micro/v2/server"

	"github.com/bimoyong/go-file/handler"
	proto "github.com/bimoyong/go-file/proto/file"
)

// TestUpload function
func TestUpload(t *testing.T) {
	var err error

	go func() {
		if err = startService(); err != nil {
			t.Error(err)
		}
	}()
	time.Sleep(time.Second)

	ctx := context.TODO()
	b64 := "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"

	rd := base64.NewDecoder(base64.StdEncoding, strings.NewReader(b64))
	req := proto.UploadReq{
		Checksum: "todo_checksum",
	}

	if err = upload(ctx, &req, rd); err != nil {
		t.Error(err)
	}
	t.Logf("Test done")

	return
}

func upload(ctx context.Context, req *proto.UploadReq, rd io.Reader) (err error) {
	srv := proto.NewFileService("go.srv.file", client.DefaultClient)
	var strm proto.File_UploadService
	if strm, err = srv.Upload(ctx); err != nil {
		err = fmt.Errorf("failed to upload file: %s", err.Error())
		return
	}
	defer strm.Close()

	// sent data in 1M chunks
	buf := make([]byte, 1<<20)

	log.Infof("Stream file for every chunk size %d", 1<<20)
	for {
		var n int
		n, err = rd.Read(buf)
		if err == io.EOF {
			err = nil
			log.Infof("Finished uploading file")
			time.Sleep(100 * time.Millisecond) // TODO: need to see why without this line the server cannot receive EOF
			break
		}
		if err != nil {
			err = fmt.Errorf("error reading file: %s", err.Error())
			break
		}

		req.Data = buf[:n]
		if err = strm.Send(req); err != nil {
			err = fmt.Errorf("error uploading file: %s", err.Error())
			break
		}
		log.Infof("Streamed %d bytes of file", n)

		var resp proto.UploadResp
		if err = strm.RecvMsg(&resp); err != nil {
			return
		}
		log.Infof("Received response %s", resp.String())
	}

	return
}

func startService() error {
	config.DefaultConfig.Set("../data", "dir_base")
	config.DefaultConfig.Set(5242880, "bytes_limit")

	service := micro.NewService()

	server.DefaultServer = service.Server()
	server.DefaultServer.Init(
		server.Name("go.srv.file"),
	)

	proto.RegisterFileHandler(server.DefaultServer, new(handler.File))

	return service.Run()
}
